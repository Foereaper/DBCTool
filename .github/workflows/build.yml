name: Build DBCTool

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - '**'
    types: [opened, synchronize, reopened]

jobs:
  build:
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'build'))

    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
          - os: windows
            arch: amd64
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          submodules: true

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '>=1.20'
          cache: false

      - name: Install dependencies
        run: go mod tidy -C src

      - name: Make build dir
        run: mkdir -p bin

      - name: Build binary
        run: |
          # Determine filename
          FILENAME="dbctool"
          if [ "${{ matrix.os }}" = "windows" ]; then
            FILENAME="dbctool.exe"
          fi
          echo "Building $FILENAME for OS=${{ matrix.os }} ARCH=${{ matrix.arch }}"
          GOOS=${{ matrix.os }} GOARCH=${{ matrix.arch }} go build -C src -o "../bin/$FILENAME"

      - name: Copy meta directory
        run: cp -r meta bin/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: dbctool-${{ matrix.os }}-${{ matrix.arch }}
          path: bin/

  linux-test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      # Download artifact into repo root
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: dbctool-linux-amd64
          path: .

      # Ensure directories exist for DBC files and export
      - name: Create required directories
        run: mkdir -p ./dbc_files ./dbc_export

      # Clone DBC repo
      - name: Clone DBC repo
        uses: actions/checkout@v3
        with:
          repository: Haeniken/TrinityCore-3.3.5-data-multilang
          path: temp_data
          sparse-checkout: |
            dbc
          sparse-checkout-cone-mode: false

      # Move dbc files to correct dir
      - name: Move dbc files to correct dir
        run: |
          mv temp_data/dbc/* ./dbc_files/
          rm -rf temp_data

      # Set up MySQL with default credentials
      - name: Set up MySQL
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql version: '8.0'
          mysql root password: 'password'

      # Wait until MySQL is ready
      - name: Wait for MySQL to start
        run: |
          for i in {1..10}; do
            if mysqladmin ping -h 127.0.0.1 -uroot -ppassword --silent; then
              echo "MySQL is ready"
              break
            fi
            echo "Waiting for MySQL..."
            sleep 3
          done

      # Create the database used by dbctool
      - name: Create test database
        run: mysql -h 127.0.0.1 -uroot -ppassword -e "CREATE DATABASE IF NOT EXISTS dbc;"

      # Make dbctool executable
      - name: Make dbctool executable
        run: chmod +x ./dbctool

      # First run: generate config
      - name: Generate config
        run: ./dbctool import
      
      # Second run: perform actual import
      - name: Import DBC files
        run: ./dbctool import

      # Run dbctool export
      - name: Export data
        run: ./dbctool export

      # Verify that export directory has files
      - name: Verify exported files
        run: ./dbctool verify