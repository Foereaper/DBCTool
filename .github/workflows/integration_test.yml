name: Linux Integration Test

on:
  workflow_run:
    workflows: ["Build DBCTool"]
    types:
      - completed

jobs:
  linux-test:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      # Download artifact into repo root
      - name: Download Linux artifact
        uses: actions/download-artifact@v4
        with:
          name: dbctool-linux-amd64
          path: .

      # Ensure directories exist for DBC files and export
      - name: Create required directories
        run: mkdir -p ./dbc_files ./dbc_export

      # Clone DBC repo and extract dbc directory
      - name: Clone DBC repo and extract dbc directory
        run: |
          git clone --depth 1 --branch master --single-branch https://github.com/ac-data/ac-data.git temp_ac_data
          mv temp_ac_data/dbc/* ./dbc_files/
          rm -rf temp_ac_data

      # Set up MySQL with default credentials
      - name: Set up MySQL
        uses: mirromutth/mysql-action@v1.1
        with:
          mysql version: '8.0'
          mysql root password: 'password'

      # Wait until MySQL is ready
      - name: Wait for MySQL to start
        run: |
          for i in {1..10}; do
            if mysqladmin ping -h 127.0.0.1 -uroot -ppassword --silent; then
              echo "MySQL is ready"
              break
            fi
            echo "Waiting for MySQL..."
            sleep 3
          done

      # Create the database used by dbctool
      - name: Create test database
        run: mysql -uroot -ppassword -e "CREATE DATABASE IF NOT EXISTS dbc;"

      # Make dbctool executable
      - name: Make dbctool executable
        run: chmod +x ./dbctool

      # First run: generate config
      - name: Generate config
        run: ./dbctool import
      
      # Second run: perform actual import
      - name: Import DBC files
        run: ./dbctool import

      # Run dbctool export
      - name: Export data
        run: ./dbctool export

      # Verify that export directory has files
      - name: Verify exported files
        run: ./dbctool verify
